<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Falmouth Heights Tide Clock</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- Include Lucide Icons for better visuals -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gradient-to-br from-blue-100 to-indigo-200 min-h-screen flex items-center justify-center font-inter p-4">
    <div class="bg-white p-8 rounded-xl shadow-2xl max-w-lg w-full text-center border-b-4 border-blue-500 transform transition-all duration-300 hover:scale-105">
        <h1 class="text-4xl font-extrabold mb-6 text-blue-800 flex items-center justify-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-Waves">
                <path d="M2 6c.63-.56 1.34-1 2.17-1.42A10 10 0 0112 2c4.17 0 6.17 1.25 8.17 2.58 1.48.97 2.17 1.42 2.17 1.42"/>
                <path d="M2 12c.63-.56 1.34-1 2.17-1.42A10 10 0 0112 8c4.17 0 6.17 1.25 8.17 2.58 1.48.97 2.17 1.42"/>
                <path d="M2 18c.63-.56 1.34-1 2.17-1.42A10 10 0 0112 14c4.17 0 6.17 1.25 8.17 2.58 1.48.97 2.17 1.42"/>
            </svg>
            Falmouth Heights Tide Clock
        </h1>

        <div class="mb-6">
            <p class="text-gray-600 text-lg mb-2">Current Local Time:</p>
            <p id="currentTime" class="text-5xl font-bold text-gray-800 mb-4"></p>
        </div>

        <div class="mb-8 p-4 bg-blue-50 border border-blue-200 rounded-lg shadow-inner">
            <label for="lastHighTide" class="block text-gray-700 text-base font-semibold mb-2">
                Set Last High Tide in UTC (Date and Time):
            </label>
            <input type="datetime-local" id="lastHighTide" class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-3 text-lg">
            <button id="setTideBtn" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105 duration-200">
                <span class="flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-Save"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                    Save Tide
                </span>
            </button>
        </div>

        <div class="space-y-4 mb-8">
            <div class="bg-green-100 p-4 rounded-lg shadow-md border-l-4 border-green-500 flex justify-between items-center">
                <p class="text-gray-700 font-semibold text-lg">Current Tide Status:</p>
                <p id="tideStatus" class="text-green-700 text-xl font-bold"></p>
            </div>
            <div class="bg-yellow-100 p-4 rounded-lg shadow-md border-l-4 border-yellow-500 flex justify-between items-center">
                <p class="text-gray-700 font-semibold text-lg">Time Until Next Tide:</p>
                <p id="timeUntilNext" class="text-yellow-700 text-xl font-bold"></p>
            </div>
            <div class="bg-purple-100 p-4 rounded-lg shadow-md border-l-4 border-purple-500 flex justify-between items-center">
                <p class="text-gray-700 font-semibold text-lg">Next High Tide:</p>
                <p id="nextHighTide" class="text-purple-700 text-xl font-bold"></p>
            </div>
            <div class="bg-red-100 p-4 rounded-lg shadow-md border-l-4 border-red-500 flex justify-between items-center">
                <p class="text-gray-700 font-semibold text-lg">Next Low Tide:</p>
                <p id="nextLowTide" class="text-red-700 text-xl font-bold"></p>
            </div>
        </div>

        <div class="mt-8">
            <p class="text-gray-500 text-sm italic">
                Note: This clock uses a simplified 12-hour, 25-minute semi-diurnal tide cycle for estimation.
                Actual tide times vary by location due to complex factors.
            </p>
        </div>
    </div>

    <script>
        // Initialize Lucide Icons
        lucide.createIcons();

        // DOM elements
        const currentTimeElem = document.getElementById('currentTime');
        const lastHighTideInput = document.getElementById('lastHighTide');
        const setTideBtn = document.getElementById('setTideBtn');
        const tideStatusElem = document.getElementById('tideStatus');
        const timeUntilNextElem = document.getElementById('timeUntilNext');
        const nextHighTideElem = document.getElementById('nextHighTide');
        const nextLowTideElem = document.getElementById('nextLowTide');

        // Constants for tide calculation
        const TIDE_CYCLE_MINUTES = 12 * 60 + 25; // 12 hours 25 minutes in minutes
        const HALF_TIDE_CYCLE_MINUTES = TIDE_CYCLE_MINUTES / 2; // ~6 hours 12.5 minutes for high to low or low to high

        // Store the last high tide timestamp (milliseconds since epoch)
        let lastHighTideTimestamp = localStorage.getItem('lastHighTideTimestamp') ?
                                    parseInt(localStorage.getItem('lastHighTideTimestamp')) : null;

        // Function to format milliseconds into HH:MM:SS
        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // Function to format a Date object to a readable string
        function formatDateTime(date) {
            if (!date) return 'N/A';
            const options = {
                weekday: 'short', year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit', hour12: true
            };
            return date.toLocaleString('en-US', options);
        }

        // Function to update the tide clock display
        function updateTideClock() {
            const now = new Date();
            currentTimeElem.textContent = formatDateTime(now);

            if (!lastHighTideTimestamp) {
                tideStatusElem.textContent = 'Please set a reference high tide.';
                timeUntilNextElem.textContent = 'N/A';
                nextHighTideElem.textContent = 'N/A';
                nextLowTideElem.textContent = 'N/A';
                return;
            }

            // Calculate minutes since last high tide
            const timeDiffMinutes = (now.getTime() - lastHighTideTimestamp) / (1000 * 60);
            // Get position within the 12h 25m cycle
            const cyclePosition = timeDiffMinutes % TIDE_CYCLE_MINUTES;

            let status = '';
            let timeUntilNext = 0;
            let nextHighTime = new Date(lastHighTideTimestamp);
            let nextLowTime = new Date(lastHighTideTimestamp + HALF_TIDE_CYCLE_MINUTES * 60 * 1000);

            // Adjust nextHighTime and nextLowTime to be in the future relative to 'now'
            while (nextHighTime.getTime() < now.getTime()) {
                nextHighTime.setTime(nextHighTime.getTime() + TIDE_CYCLE_MINUTES * 60 * 1000);
            }
            while (nextLowTime.getTime() < now.getTime()) {
                nextLowTime.setTime(nextLowTime.getTime() + TIDE_CYCLE_MINUTES * 60 * 1000);
            }

            // Determine current tide status and time until next specific tide
            if (cyclePosition >= 0 && cyclePosition < HALF_TIDE_CYCLE_MINUTES) {
                // First half of cycle after high tide: Tide is falling towards low tide
                status = 'Falling';
                // Time until next low tide (from current time to nextLowTime)
                timeUntilNext = nextLowTime.getTime() - now.getTime();
            } else {
                // Second half of cycle after low tide: Tide is rising towards high tide
                status = 'Rising';
                // Time until next high tide (from current time to nextHighTime)
                timeUntilNext = nextHighTime.getTime() - now.getTime();
            }

            // Check if very close to high or low tide (within a small margin, e.g., 5 minutes)
            const timeToNextHigh = nextHighTime.getTime() - now.getTime();
            const timeToNextLow = nextLowTime.getTime() - now.getTime();
            const margin = 5 * 60 * 1000; // 5 minutes in milliseconds

            if (Math.abs(timeToNextHigh) < margin) {
                status = 'High Tide';
            } else if (Math.abs(timeToNextLow) < margin) {
                status = 'Low Tide';
            }


            tideStatusElem.textContent = status;
            timeUntilNextElem.textContent = formatTime(timeUntilNext);
            nextHighTideElem.textContent = formatDateTime(nextHighTime);
            nextLowTideElem.textContent = formatDateTime(nextLowTime);
        }

        // Event listener for setting the last high tide
        setTideBtn.addEventListener('click', () => {
            if (lastHighTideInput.value) {
                const selectedDate = new Date(lastHighTideInput.value);
                if (!isNaN(selectedDate.getTime())) {
                    lastHighTideTimestamp = selectedDate.getTime();
                    localStorage.setItem('lastHighTideTimestamp', lastHighTideTimestamp);
                    updateTideClock();
                } else {
                    // Using a custom message box instead of alert()
                    const messageBox = document.createElement('div');
                    messageBox.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                    messageBox.innerHTML = `
                        <div class="bg-white p-6 rounded-lg shadow-xl text-center">
                            <p class="text-lg font-semibold mb-4">Please enter a valid date and time.</p>
                            <button onclick="this.parentNode.parentNode.remove()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">OK</button>
                        </div>
                    `;
                    document.body.appendChild(messageBox);
                }
            } else {
                // Using a custom message box instead of alert()
                const messageBox = document.createElement('div');
                messageBox.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                messageBox.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl text-center">
                        <p class="text-lg font-semibold mb-4">Please select a date and time for the last high tide.</p>
                        <button onclick="this.parentNode.parentNode.remove()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">OK</button>
                    </div>
                `;
                document.body.appendChild(messageBox);
            }
        });

        // Initialize input field
        // If a value is stored in localStorage, use it
        if (lastHighTideTimestamp) {
            const storedDate = new Date(lastHighTideTimestamp);
            lastHighTideInput.value = storedDate.toISOString().substring(0, 16);
        } else {
            // If no value is stored, pre-select 11 AM ET today
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const day = now.getDate();

            // Create a Date object representing 11:00 AM ET today.
            // Eastern Time (ET) observes Daylight Saving Time. In August, it's Eastern Daylight Time (EDT), which is UTC-4.
            // So, 11:00 AM ET (EDT) is 15:00 UTC (11 + 4 = 15).
            const preselectedDate = new Date(Date.UTC(2025, 8, 8, 15, 0, 0)); // 15:00 UTC for 11:00 AM EDT/ET

            lastHighTideInput.value = preselectedDate.toISOString().substring(0, 16);

            // Also update the lastHighTideTimestamp variable and localStorage with this pre-selected value
            lastHighTideTimestamp = preselectedDate.getTime();
            localStorage.setItem('lastHighTideTimestamp', lastHighTideTimestamp);
        }

        // Update the clock every second
        setInterval(updateTideClock, 1000);

        // Initial update when the page loads
        window.onload = function() {
            updateTideClock();
        };
    </script>
</body>
</html>
